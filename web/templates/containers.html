<!DOCTYPE html>
<html lang="en" data-bs-theme="{{ .theme }}">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ .title }} - Containers</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        [data-bs-theme="light"] body { background: #f0f2f5; }
        [data-bs-theme="dark"] body { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); }
        .sidebar { min-height: 100vh; background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); position: fixed; top: 0; left: 0; }
        [data-bs-theme="dark"] .sidebar { background: rgba(30,30,40,0.95); }
        .nav-link { transition: all 0.3s; border-radius: 8px; margin: 4px 8px; }
        .nav-link:hover { background: rgba(102,126,234,0.1); transform: translateX(5px); }
        .nav-link.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white !important; box-shadow: 0 4px 15px rgba(102,126,234,0.4); }
        .card { border: none; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); background: white; }
        [data-bs-theme="dark"] .card { background: rgba(30,30,40,0.95); }
        main { background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); border-radius: 20px; margin: 20px; padding: 20px; }
        [data-bs-theme="light"] main { background: white; }
        [data-bs-theme="dark"] main { background: rgba(30,30,40,0.95); }
        .log-viewer { background: #1e1e1e; color: #d4d4d4; font-family: 'Courier New', monospace; padding: 1rem; border-radius: 10px; max-height: 500px; overflow-y: auto; }
        .btn-gradient { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; color: white; transition: all 0.3s; }
        .btn-gradient:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(102,126,234,0.4); color: white; }
        .toast-container { z-index: 9999; }
    </style>
</head>
<body>
    <div class="toast-container position-fixed top-0 end-0 p-3"></div>
    <div class="container-fluid"><div class="row">
        <nav class="col-md-2 d-md-block sidebar collapse"><div class="position-sticky pt-3">
            <h5 class="px-3 mb-3" style="background: linear-gradient(135deg, #667eea, #764ba2); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 700;">{{ .title }}</h5>
            <ul class="nav flex-column">
                <li class="nav-item"><a class="nav-link" href="/"><i class="bi bi-speedometer2"></i> Dashboard</a></li>
                <li class="nav-item"><a class="nav-link active" href="/containers"><i class="bi bi-box-seam"></i> Containers</a></li>
                <li class="nav-item"><a class="nav-link" href="/pods"><i class="bi bi-boxes"></i> Pods</a></li>
                <li class="nav-item"><a class="nav-link" href="/scheduler"><i class="bi bi-clock"></i> Scheduler</a></li>
                <li class="nav-item"><a class="nav-link" href="/config"><i class="bi bi-gear"></i> Configuration</a></li>
                <li class="nav-item"><a class="nav-link" href="/logs"><i class="bi bi-file-text"></i> Logs</a></li>
            </ul>
        </div></nav>
        <main class="col-md-10 ms-sm-auto px-md-4">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3">
                <h1 class="h2" style="background: linear-gradient(135deg, #667eea, #764ba2); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 700;">Containers</h1>
            </div>
            <div class="row mb-3"><div class="col-md-12"><div class="card"><div class="card-header bg-transparent border-0 pt-3"><h5 class="card-title mb-0">Filters</h5></div><div class="card-body"><div class="row g-3">
                <div class="col-md-4"><label class="form-label">Runtime</label><select class="form-select" id="filterRuntime" onchange="loadContainers()"><option value="all">All</option><option value="docker">Docker</option><option value="podman">Podman</option></select></div>
                <div class="col-md-4"><label class="form-label">Status</label><select class="form-select" id="filterStatus" onchange="loadContainers()"><option value="">All</option><option value="running" selected>Running</option><option value="exited">Exited</option></select></div>
                <div class="col-md-4"><label class="form-label">Name</label><input type="text" class="form-control" id="filterName" placeholder="Filter by name" onkeyup="loadContainers()"></div>
            </div></div></div></div></div>
            <div class="row"><div class="col-md-12"><div class="card"><div class="card-header bg-transparent border-0 pt-3 d-flex justify-content-between align-items-center"><h5 class="card-title mb-0">Container List</h5><div><button class="btn btn-gradient btn-sm me-2" data-bs-toggle="modal" data-bs-target="#createModal"><i class="bi bi-play-circle"></i> Create</button><button class="btn btn-gradient btn-sm" data-bs-toggle="modal" data-bs-target="#buildModal"><i class="bi bi-plus-circle"></i> Build</button></div></div><div class="card-body"><div class="table-responsive"><table class="table table-hover"><thead><tr><th>Name</th><th>Image</th><th>Status</th><th>Runtime</th><th>Ports</th><th>Caddy Domain</th><th>Caddy Port</th><th>Created</th><th>CPU</th><th>Memory</th><th>Actions</th></tr></thead><tbody id="containerList"><tr><td colspan="11" class="text-center">Loading...</td></tr></tbody></table></div></div></div></div></div>
        </main>
    </div></div>
    <div class="modal fade" id="createModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Create Container from Image</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="createForm" class="needs-validation" novalidate><div class="mb-3"><label class="form-label">Container Name <span class="text-danger">*</span></label><input type="text" class="form-control" id="containerName" placeholder="my-container" required pattern="^[a-zA-Z0-9][a-zA-Z0-9_.-]*$"><div class="invalid-feedback">Please provide a valid container name</div></div><div class="mb-3"><label class="form-label">Image <span class="text-danger">*</span></label><input type="text" class="form-control" id="containerImage" placeholder="nginx:latest" required><div class="invalid-feedback">Please provide an image name</div></div><div class="mb-3"><label class="form-label">Runtime <span class="text-danger">*</span></label><select class="form-select" id="createRuntime" required><option value="docker">Docker</option><option value="podman">Podman</option></select></div><div class="mb-3"><label class="form-label">Restart Policy</label><select class="form-select" id="restartPolicy"><option value="">No</option><option value="always">Always</option><option value="unless-stopped">Unless Stopped</option><option value="on-failure">On Failure</option></select></div><div class="mb-3"><label class="form-label">Port Mappings</label><div id="portMappings"><div class="input-group mb-2"><input type="number" class="form-control" placeholder="Host Port (e.g., 8080)" id="hostPort0"><input type="number" class="form-control" placeholder="Container Port (e.g., 80)" id="containerPort0"><button type="button" class="btn btn-outline-secondary" onclick="addPortMapping()"><i class="bi bi-plus"></i></button></div></div><small class="text-muted">Format: HostPort:ContainerPort</small></div><div class="mb-3"><label class="form-label">Volumes</label><div id="volumeMappings"><div class="input-group mb-2"><input type="text" class="form-control" placeholder="Host Path (e.g., /host/data)" id="hostPath0"><input type="text" class="form-control" placeholder="Container Path (e.g., /data)" id="containerPath0"><button type="button" class="btn btn-outline-secondary" onclick="addVolumeMapping()"><i class="bi bi-plus"></i></button></div></div><small class="text-muted">Format: HostPath:ContainerPath</small></div><div class="mb-3"><label class="form-label">Environment Variables</label><textarea class="form-control" id="envVars" rows="3" placeholder="KEY1=value1&#10;KEY2=value2"></textarea><small class="text-muted">One per line in KEY=VALUE format</small></div></form></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button><button type="button" class="btn btn-gradient" onclick="createContainer()">Create</button></div></div></div></div>
    <div class="modal fade" id="buildModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Build from Dockerfile</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="buildForm" class="needs-validation" novalidate><div class="mb-3"><label class="form-label">Image Name <span class="text-danger">*</span></label><input type="text" class="form-control" id="imageName" placeholder="my-image:latest" required pattern="^[a-zA-Z0-9][a-zA-Z0-9_.-]*(/[a-zA-Z0-9][a-zA-Z0-9_.-]*)*(:[a-zA-Z0-9_.-]+)?$"><div class="invalid-feedback">Please provide a valid image name (e.g., my-image:latest)</div></div><div class="mb-3"><label class="form-label">Runtime <span class="text-danger">*</span></label><select class="form-select" id="buildRuntime" required><option value="docker">Docker</option><option value="podman">Podman</option></select></div><div class="mb-3"><label class="form-label">Dockerfile <span class="text-danger">*</span></label><textarea class="form-control" id="dockerfile" rows="10" placeholder="FROM alpine:latest" required minlength="10"></textarea><div class="invalid-feedback">Please provide Dockerfile content</div></div></form></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button><button type="button" class="btn btn-gradient" onclick="buildImage()">Build</button></div></div></div></div>
    <div class="modal fade" id="logsModal" tabindex="-1"><div class="modal-dialog modal-xl"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Container Logs: <span id="logContainerName"></span></h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="log-viewer" id="logContent">Loading...</div></div></div></div></div>
    <div class="modal fade" id="caddyModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Configure Caddy Labels: <span id="caddyContainerName"></span></h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="alert alert-info"><i class="bi bi-info-circle"></i> <strong>About Caddy Labels:</strong> These labels configure automatic reverse proxy for your container. You need to activate Caddy configuration in the <a href="/config" class="alert-link">Configuration page</a> for these labels to take effect.</div><form id="caddyForm" class="needs-validation" novalidate><div class="mb-3"><label class="form-label">Domain <span class="text-danger">*</span></label><input type="text" class="form-control" id="caddyDomain" placeholder="example.com" required><div class="invalid-feedback">Please provide a domain name</div><small class="text-muted">The domain name for the reverse proxy (e.g., example.com)</small></div><div class="mb-3"><label class="form-label">Port <span class="text-danger">*</span></label><input type="number" class="form-control" id="caddyPort" placeholder="8080" required><div class="invalid-feedback">Please provide a port number</div><small class="text-muted">The container port to proxy to (e.g., 8080)</small></div><div class="mb-3"><label class="form-label">Path</label><input type="text" class="form-control" id="caddyPath" placeholder="/" value="/"><small class="text-muted">The URL path prefix (default: /)</small></div><div class="mb-3"><label class="form-label">TLS</label><select class="form-select" id="caddyTLS"><option value="auto" selected>Auto (Let's Encrypt)</option><option value="off">Off (No TLS)</option><option value="internal">Internal (Self-signed)</option></select><small class="text-muted">TLS/HTTPS configuration (default: auto)</small></div></form></div><div class="modal-footer"><button type="button" class="btn btn-danger" onclick="deleteCaddyLabels()"><i class="bi bi-trash"></i> Delete Labels</button><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button><button type="button" class="btn btn-gradient" onclick="saveCaddyLabels()">Save</button></div></div></div></div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
function showToast(message, type = 'info') {
    const toastContainer = document.querySelector('.toast-container');
    const toastId = 'toast-' + Date.now();
    const bgClass = type === 'success' ? 'bg-success' : type === 'error' ? 'bg-danger' : 'bg-info';
    const icon = type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle';
    const toast = `<div id="${toastId}" class="toast align-items-center text-white ${bgClass} border-0" role="alert"><div class="d-flex"><div class="toast-body"><i class="bi bi-${icon}"></i> ${message}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div></div>`;
    toastContainer.insertAdjacentHTML('beforeend', toast);
    const toastEl = new bootstrap.Toast(document.getElementById(toastId), { delay: 3000 });
    toastEl.show();
    setTimeout(() => document.getElementById(toastId)?.remove(), 4000);
}

function loadContainers() {
    const rt = document.getElementById('filterRuntime').value, st = document.getElementById('filterStatus').value, nm = document.getElementById('filterName').value;
    let url = `/api/containers?runtime=${rt}&include_stats=true&include_privileged=true`;
    if (st) url += `&status=${st}`;
    if (nm) url += `&name=${nm}`;
    fetch(url)
        .then(r => {
            if (!r.ok) throw new Error('Failed to load containers');
            return r.json();
        })
        .then(data=>{
            const c = data.containers || []; const tbody = document.getElementById('containerList');
            tbody.innerHTML = c.length===0 ? '<tr><td colspan="11" class="text-center">No containers</td></tr>' :
                c.map(x => {
                    const created = new Date(x.created).toLocaleDateString();
                    const cpuDisplay = x.stats && x.state === 'running' ? `${x.stats.cpu_percent.toFixed(1)}%` : '-';
                    const memDisplay = x.stats && x.state === 'running' ? formatBytes(x.stats.memory_usage) : '-';
                    const privilegedBadge = x.privileged ? '<span class="badge bg-warning text-dark ms-1" title="Privileged"><i class="bi bi-shield-lock"></i></span>' : '';
                    const portsDisplay = x.ports && x.ports.length > 0 ? x.ports.map(p => `${p.host_port}:${p.container_port}`).join(', ') : '-';
                    const caddyDomain = x.labels && x.labels['caddy.domain'] ? x.labels['caddy.domain'] : '-';
                    const caddyPort = x.labels && x.labels['caddy.port'] ? x.labels['caddy.port'] : '-';
                    const hasCaddy = x.labels && x.labels['caddy.domain'];
                    return `<tr><td>${x.name}${privilegedBadge}</td><td>${x.image}</td><td><span class="badge bg-${x.state==='running'?'success':'secondary'}">${x.state}</span></td><td><span class="badge bg-info">${x.runtime}</span></td><td>${portsDisplay}</td><td>${caddyDomain}</td><td>${caddyPort}</td><td>${created}</td><td>${cpuDisplay}</td><td>${memDisplay}</td><td>
                        ${x.state==='running'?`<button class="btn btn-sm btn-warning" onclick="stopContainer('${x.id}','${x.runtime}')"><i class="bi bi-stop-circle"></i></button>`:`<button class="btn btn-sm btn-success" onclick="startContainer('${x.id}','${x.runtime}')"><i class="bi bi-play-circle"></i></button>`}
                        <button class="btn btn-sm btn-info" onclick="restartContainer('${x.id}','${x.runtime}')"><i class="bi bi-arrow-clockwise"></i></button>
                        <button class="btn btn-sm ${hasCaddy?'btn-primary':'btn-outline-primary'}" onclick="configureCaddy('${x.id}','${x.name}','${x.runtime}')"><i class="bi bi-gear"></i></button>
                        <button class="btn btn-sm btn-outline-primary" onclick="viewLogs('${x.id}','${x.name}','${x.runtime}')"><i class="bi bi-file-text"></i></button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteContainer('${x.id}','${x.runtime}')"><i class="bi bi-trash"></i></button>
                    </td></tr>`;
                }).join('');
        })
        .catch(err => showToast('Error loading containers: ' + err.message, 'error'));
}

function formatBytes(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}

let portCounter = 1;
let volumeCounter = 1;

function addPortMapping() {
    const container = document.getElementById('portMappings');
    const newMapping = `<div class="input-group mb-2"><input type="number" class="form-control" placeholder="Host Port" id="hostPort${portCounter}"><input type="number" class="form-control" placeholder="Container Port" id="containerPort${portCounter}"><button type="button" class="btn btn-outline-danger" onclick="this.parentElement.remove()"><i class="bi bi-trash"></i></button></div>`;
    container.insertAdjacentHTML('beforeend', newMapping);
    portCounter++;
}

function addVolumeMapping() {
    const container = document.getElementById('volumeMappings');
    const newMapping = `<div class="input-group mb-2"><input type="text" class="form-control" placeholder="Host Path" id="hostPath${volumeCounter}"><input type="text" class="form-control" placeholder="Container Path" id="containerPath${volumeCounter}"><button type="button" class="btn btn-outline-danger" onclick="this.parentElement.remove()"><i class="bi bi-trash"></i></button></div>`;
    container.insertAdjacentHTML('beforeend', newMapping);
    volumeCounter++;
}

function createContainer() {
    const form = document.getElementById('createForm');
    if (!form.checkValidity()) {
        form.classList.add('was-validated');
        showToast('Please fill in all required fields correctly', 'error');
        return;
    }
    
    const name = document.getElementById('containerName').value;
    const image = document.getElementById('containerImage').value;
    const runtime = document.getElementById('createRuntime').value;
    const restart = document.getElementById('restartPolicy').value;
    
    // Collect port mappings
    const ports = [];
    for (let i = 0; i < portCounter; i++) {
        const hostPort = document.getElementById(`hostPort${i}`);
        const containerPort = document.getElementById(`containerPort${i}`);
        if (hostPort && containerPort && hostPort.value && containerPort.value) {
            ports.push(`${hostPort.value}:${containerPort.value}`);
        }
    }
    
    // Collect volume mappings
    const volumes = [];
    for (let i = 0; i < volumeCounter; i++) {
        const hostPath = document.getElementById(`hostPath${i}`);
        const containerPath = document.getElementById(`containerPath${i}`);
        if (hostPath && containerPath && hostPath.value && containerPath.value) {
            volumes.push(`${hostPath.value}:${containerPath.value}`);
        }
    }
    
    // Parse environment variables
    const envVarsText = document.getElementById('envVars').value;
    const envVars = envVarsText.split('\n').filter(line => line.trim() && line.includes('=')).map(line => line.trim());
    
    const payload = {
        name: name,
        image: image,
        runtime: runtime,
        restart_policy: restart,
        ports: ports,
        volumes: volumes,
        env_vars: envVars
    };
    
    showToast('Creating container...', 'info');
    fetch('/api/containers/run', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) })
        .then(r => { 
            if (!r.ok) throw new Error('Failed to create container'); 
            return r.json(); 
        })
        .then(() => { 
            showToast('Container created successfully', 'success');
            bootstrap.Modal.getInstance(document.getElementById('createModal')).hide();
            form.classList.remove('was-validated');
            form.reset();
            portCounter = 1;
            volumeCounter = 1;
            loadContainers();
        })
        .catch(err => showToast('Error creating container: ' + err.message, 'error'));
}

function buildImage() {
    const form = document.getElementById('buildForm');
    if (!form.checkValidity()) {
        form.classList.add('was-validated');
        showToast('Please fill in all required fields correctly', 'error');
        return;
    }
    
    const name = document.getElementById('imageName').value, rt = document.getElementById('buildRuntime').value, df = document.getElementById('dockerfile').value;
    showToast('Building image...', 'info');
    fetch('/api/containers', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({image_name: name, runtime: rt, dockerfile: df}) })
        .then(r => {
            if (!r.ok) throw new Error('Failed to build image');
            return r.json();
        })
        .then(()=>{ 
            showToast('Image built successfully', 'success');
            bootstrap.Modal.getInstance(document.getElementById('buildModal')).hide();
            form.classList.remove('was-validated');
            form.reset();
            loadContainers();
        })
        .catch(err => showToast('Error building image: ' + err.message, 'error'));
}

function startContainer(id, rt) {
    showToast('Starting container...', 'info');
    fetch(`/api/containers/${id}/start?runtime=${rt}`, {method: 'POST'})
        .then(r => {
            if (!r.ok) throw new Error('Failed to start container');
            return r.json();
        })
        .then(()=>{ showToast('Container started successfully', 'success'); loadContainers(); })
        .catch(err => showToast('Error starting container: ' + err.message, 'error'));
}

function stopContainer(id, rt) {
    showToast('Stopping container...', 'info');
    fetch(`/api/containers/${id}/stop?runtime=${rt}`, {method: 'POST'})
        .then(r => {
            if (!r.ok) throw new Error('Failed to stop container');
            return r.json();
        })
        .then(()=>{ showToast('Container stopped successfully', 'success'); loadContainers(); })
        .catch(err => showToast('Error stopping container: ' + err.message, 'error'));
}

function restartContainer(id, rt) {
    showToast('Restarting container...', 'info');
    fetch(`/api/containers/${id}/restart?runtime=${rt}`, {method: 'POST'})
        .then(r => {
            if (!r.ok) throw new Error('Failed to restart container');
            return r.json();
        })
        .then(()=>{ showToast('Container restarted successfully', 'success'); loadContainers(); })
        .catch(err => showToast('Error restarting container: ' + err.message, 'error'));
}

function deleteContainer(id, rt) {
    if (!confirm('Are you sure you want to delete this container?')) return;
    showToast('Deleting container...', 'info');
    fetch(`/api/containers/${id}?runtime=${rt}&force=true`, {method: 'DELETE'})
        .then(r => {
            if (!r.ok) throw new Error('Failed to delete container');
            return r.json();
        })
        .then(()=>{ showToast('Container deleted successfully', 'success'); loadContainers(); })
        .catch(err => showToast('Error deleting container: ' + err.message, 'error'));
}

function viewLogs(id, name, rt) {
    document.getElementById('logContainerName').textContent = name; document.getElementById('logContent').textContent = 'Loading...';
    new bootstrap.Modal(document.getElementById('logsModal')).show();
    fetch(`/api/containers/${id}/logs?runtime=${rt}&tail=100`)
        .then(r => {
            if (!r.ok) throw new Error('Failed to load logs');
            return r.text();
        })
        .then(logs=>document.getElementById('logContent').textContent = logs || 'No logs')
        .catch(err => {
            document.getElementById('logContent').textContent = 'Error loading logs: ' + err.message;
            showToast('Error loading logs: ' + err.message, 'error');
        });
}

let currentCaddyContainerID = '';
let currentCaddyContainerRuntime = '';

function configureCaddy(id, name, rt) {
    currentCaddyContainerID = id;
    currentCaddyContainerRuntime = rt;
    document.getElementById('caddyContainerName').textContent = name;
    
    // Load existing Caddy labels
    fetch(`/api/containers?runtime=${rt}`)
        .then(r => r.json())
        .then(data => {
            const container = data.containers.find(c => c.id === id);
            if (container && container.labels) {
                document.getElementById('caddyDomain').value = container.labels['caddy.domain'] || '';
                document.getElementById('caddyPort').value = container.labels['caddy.port'] || '';
                document.getElementById('caddyPath').value = container.labels['caddy.path'] || '/';
                document.getElementById('caddyTLS').value = container.labels['caddy.tls'] || 'auto';
            }
        })
        .catch(err => console.error('Error loading container labels:', err));
    
    new bootstrap.Modal(document.getElementById('caddyModal')).show();
}

function saveCaddyLabels() {
    const form = document.getElementById('caddyForm');
    if (!form.checkValidity()) {
        form.classList.add('was-validated');
        showToast('Please fill in all required fields', 'error');
        return;
    }
    
    const domain = document.getElementById('caddyDomain').value;
    const port = document.getElementById('caddyPort').value;
    const path = document.getElementById('caddyPath').value;
    const tls = document.getElementById('caddyTLS').value;
    
    const payload = {
        domain: domain,
        port: port,
        path: path,
        tls: tls
    };
    
    showToast('Updating Caddy labels...', 'info');
    fetch(`/api/containers/${currentCaddyContainerID}/caddy-labels?runtime=${currentCaddyContainerRuntime}`, {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
    })
        .then(r => {
            if (!r.ok) throw new Error('Failed to update Caddy labels');
            return r.json();
        })
        .then(() => {
            showToast('Caddy labels updated successfully', 'success');
            bootstrap.Modal.getInstance(document.getElementById('caddyModal')).hide();
            form.classList.remove('was-validated');
            loadContainers();
        })
        .catch(err => showToast('Error updating Caddy labels: ' + err.message, 'error'));
}

function deleteCaddyLabels() {
    if (!confirm('Are you sure you want to delete all Caddy labels from this container?')) return;
    
    showToast('Deleting Caddy labels...', 'info');
    fetch(`/api/containers/${currentCaddyContainerID}/caddy-labels?runtime=${currentCaddyContainerRuntime}`, {
        method: 'DELETE'
    })
        .then(r => {
            if (!r.ok) throw new Error('Failed to delete Caddy labels');
            return r.json();
        })
        .then(() => {
            showToast('Caddy labels deleted successfully', 'success');
            bootstrap.Modal.getInstance(document.getElementById('caddyModal')).hide();
            document.getElementById('caddyForm').reset();
            loadContainers();
        })
        .catch(err => showToast('Error deleting Caddy labels: ' + err.message, 'error'));
}

// Reset counters when modals are opened
document.addEventListener('DOMContentLoaded', function() {
    const createModal = document.getElementById('createModal');
    if (createModal) {
        createModal.addEventListener('show.bs.modal', function() {
            portCounter = 1;
            volumeCounter = 1;
        });
    }
});

loadContainers(); setInterval(loadContainers, 5000);
    </script>
</body>
</html>
