<!DOCTYPE html>
<html lang="en" data-bs-theme="{{ .theme }}">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ .title }} - Scheduler</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>.sidebar { min-height: 100vh; background-color: var(--bs-light); } [data-bs-theme="dark"] .sidebar { background-color: var(--bs-dark); } .nav-link.active { background-color: var(--bs-primary); color: white !important; } .toast-container { z-index: 9999; }</style>
</head>
<body>
    <div class="toast-container position-fixed top-0 end-0 p-3"></div>
    <div class="container-fluid"><div class="row">
        <nav class="col-md-2 d-md-block sidebar collapse"><div class="position-sticky pt-3">
            <h5 class="px-3 mb-3">{{ .title }}</h5><ul class="nav flex-column">
                <li class="nav-item"><a class="nav-link" href="/"><i class="bi bi-speedometer2"></i> Dashboard</a></li>
                <li class="nav-item"><a class="nav-link" href="/containers"><i class="bi bi-box-seam"></i> Containers</a></li>
                <li class="nav-item"><a class="nav-link" href="/pods"><i class="bi bi-boxes"></i> Pods</a></li>
                <li class="nav-item"><a class="nav-link active" href="/scheduler"><i class="bi bi-clock"></i> Scheduler</a></li>
                <li class="nav-item"><a class="nav-link" href="/config"><i class="bi bi-gear"></i> Configuration</a></li>
            </ul>
        </div></nav>
        <main class="col-md-10 ms-sm-auto px-md-4">
            <div class="d-flex justify-content-between pt-3 pb-2 mb-3 border-bottom"><h1 class="h2">Scheduler</h1></div>
            <div class="row"><div class="col-md-8"><div class="card"><div class="card-header"><h5 class="card-title mb-0">Configuration</h5></div><div class="card-body"><form id="schedulerForm" class="needs-validation" novalidate>
                <div class="mb-3"><div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="enabled"><label class="form-check-label" for="enabled">Enable automatic updates</label></div></div>
                <div class="mb-3"><label class="form-label">Schedule (Cron) <span class="text-danger">*</span></label><input type="text" class="form-control" id="schedule" placeholder="0 2 * * *" required pattern="^(\*|([0-9]|1[0-9]|2[0-9]|3[0-9]|4[0-9]|5[0-9])|\*\/([0-9]|1[0-9]|2[0-9]|3[0-9]|4[0-9]|5[0-9])) (\*|([0-9]|1[0-9]|2[0-3])|\*\/([0-9]|1[0-9]|2[0-3])) (\*|([1-9]|1[0-9]|2[0-9]|3[0-1])|\*\/([1-9]|1[0-9]|2[0-9]|3[0-1])) (\*|([1-9]|1[0-2])|\*\/([1-9]|1[0-2])) (\*|([0-6])|\*\/([0-6]))$"><div class="form-text">Examples: "0 2 * * *" (2 AM daily), "0 */4 * * *" (every 4 hours)</div><div class="invalid-feedback">Please provide a valid cron expression</div></div>
                <div class="mb-3"><label class="form-label">Filters (one per line)</label><textarea class="form-control" id="filters" rows="5" placeholder="app-*&#10;service-*"></textarea><div class="form-text">Enter container name patterns to filter which containers are updated</div></div>
                <button type="submit" class="btn btn-primary"><i class="bi bi-save"></i> Save</button>
            </form></div></div></div>
            <div class="col-md-4"><div class="card"><div class="card-header"><h5 class="card-title mb-0">Status</h5></div><div class="card-body"><dl class="row"><dt class="col-sm-5">Status:</dt><dd class="col-sm-7"><span id="st" class="badge bg-secondary">-</span></dd><dt class="col-sm-5">Schedule:</dt><dd class="col-sm-7" id="sc">-</dd></dl></div></div></div></div>
        </main>
    </div></div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
function showToast(message, type = 'info') {
    const toastContainer = document.querySelector('.toast-container');
    const toastId = 'toast-' + Date.now();
    const bgClass = type === 'success' ? 'bg-success' : type === 'error' ? 'bg-danger' : 'bg-info';
    const icon = type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle';
    const toast = `<div id="${toastId}" class="toast align-items-center text-white ${bgClass} border-0" role="alert"><div class="d-flex"><div class="toast-body"><i class="bi bi-${icon}"></i> ${message}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div></div>`;
    toastContainer.insertAdjacentHTML('beforeend', toast);
    const toastEl = new bootstrap.Toast(document.getElementById(toastId), { delay: 3000 });
    toastEl.show();
    setTimeout(() => document.getElementById(toastId)?.remove(), 4000);
}

function load() {
    showToast('Loading scheduler configuration...', 'info');
    fetch('/api/scheduler/config')
        .then(r => {
            if (!r.ok) throw new Error('Failed to load scheduler configuration');
            return r.json();
        })
        .then(d => {
            document.getElementById('enabled').checked = d.enabled || false;
            document.getElementById('schedule').value = d.schedule || '';
            document.getElementById('filters').value = (d.filters || []).join('\n');
            document.getElementById('st').textContent = d.enabled ? 'Enabled' : 'Disabled';
            document.getElementById('st').className = `badge ${d.enabled ? 'bg-success' : 'bg-secondary'}`;
            document.getElementById('sc').textContent = d.schedule || 'Not set';
            showToast('Configuration loaded successfully', 'success');
        })
        .catch(err => showToast('Error loading configuration: ' + err.message, 'error'));
}

document.getElementById('schedulerForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    if (!this.checkValidity()) {
        e.stopPropagation();
        this.classList.add('was-validated');
        showToast('Please fill in all required fields correctly', 'error');
        return;
    }
    
    const en = document.getElementById('enabled').checked, sc = document.getElementById('schedule').value, ft = document.getElementById('filters').value.split('\n').filter(f => f.trim()).map(f => f.trim());
    
    showToast('Saving configuration...', 'info');
    fetch('/api/scheduler/config', {method: 'PUT', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({enabled: en, schedule: sc, filters: ft})})
        .then(r => {
            if (!r.ok) throw new Error('Failed to save configuration');
            return r.json();
        })
        .then(() => {
            showToast('Configuration saved successfully', 'success');
            this.classList.remove('was-validated');
            load();
        })
        .catch(err => showToast('Error saving configuration: ' + err.message, 'error'));
});

load();
    </script>
</body>
</html>
